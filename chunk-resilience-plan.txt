│ Here is Claude's plan:                                                                                                                                                                                                          │
│ ╭─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮ │
│ │ Plan to Build Resilient Chunk-Based Audio Generation                                                                                                                                                                        │ │
│ │                                                                                                                                                                                                                             │ │
│ │ Problem Analysis                                                                                                                                                                                                            │ │
│ │                                                                                                                                                                                                                             │ │
│ │ The current implementation generates all 6 chunks in parallel using Promise.all(), which fails completely if any chunk times out. When chunk 6 times out, the entire audio generation fails and nothing is stored.          │ │
│ │                                                                                                                                                                                                                             │ │
│ │ Proposed Solution                                                                                                                                                                                                           │ │
│ │                                                                                                                                                                                                                             │ │
│ │ 1. Store Individual Chunks in R2                                                                                                                                                                                            │ │
│ │                                                                                                                                                                                                                             │ │
│ │ - Modify generateAudioWithChunking() to store each chunk as blogs/{slug}/audio-chunk-{n}.mp3                                                                                                                                │ │
│ │ - Store a metadata file blogs/{slug}/audio-metadata.json containing:                                                                                                                                                        │ │
│ │ {                                                                                                                                                                                                                           │ │
│ │   "totalChunks": 6,                                                                                                                                                                                                         │ │
│ │   "completedChunks": [0, 1, 2, 3, 4],                                                                                                                                                                                       │ │
│ │   "chunkSizes": [12345, 23456, ...],                                                                                                                                                                                        │ │
│ │   "lastUpdated": "2025-09-03T..."                                                                                                                                                                                           │ │
│ │ }                                                                                                                                                                                                                           │ │
│ │                                                                                                                                                                                                                             │ │
│ │ 2. Implement Progressive Chunk Generation                                                                                                                                                                                   │ │
│ │                                                                                                                                                                                                                             │ │
│ │ - Check which chunks exist before generating                                                                                                                                                                                │ │
│ │ - Use Promise.allSettled() instead of Promise.all() to handle partial failures                                                                                                                                              │ │
│ │ - Generate only missing chunks on subsequent requests                                                                                                                                                                       │ │
│ │ - Update metadata after each successful chunk generation                                                                                                                                                                    │ │
│ │                                                                                                                                                                                                                             │ │
│ │ 3. API Response Strategy                                                                                                                                                                                                    │ │
│ │                                                                                                                                                                                                                             │ │
│ │ - Return HTTP 206 (Partial Content) when not all chunks are available                                                                                                                                                       │ │
│ │ - Include custom headers:                                                                                                                                                                                                   │ │
│ │   - X-Audio-Status: partial or complete                                                                                                                                                                                     │ │
│ │   - X-Total-Chunks: 6                                                                                                                                                                                                       │ │
│ │   - X-Available-Chunks: 5                                                                                                                                                                                                   │ │
│ │ - Return the combined available chunks as audio                                                                                                                                                                             │ │
│ │                                                                                                                                                                                                                             │ │
│ │ 4. Client-Side Progressive Loading                                                                                                                                                                                          │ │
│ │                                                                                                                                                                                                                             │ │
│ │ - Modify AudioPlayer to:                                                                                                                                                                                                    │ │
│ │   - Start playing available chunks immediately                                                                                                                                                                              │ │
│ │   - Poll for missing chunks in background (exponential backoff)                                                                                                                                                             │ │
│ │   - Seamlessly append new chunks when available                                                                                                                                                                             │ │
│ │   - Show progress indicator (e.g., "Loading audio: 5/6 parts ready")                                                                                                                                                        │ │
│ │                                                                                                                                                                                                                             │ │
│ │ 5. Implementation Steps                                                                                                                                                                                                     │ │
│ │                                                                                                                                                                                                                             │ │
│ │ Backend Changes:                                                                                                                                                                                                            │ │
│ │ 1. Modify src/lib/workers-ai.ts:                                                                                                                                                                                            │ │
│ │   - Add generateAudioWithResilientChunking() function                                                                                                                                                                       │ │
│ │   - Store chunks individually with error handling                                                                                                                                                                           │ │
│ │   - Track chunk generation status                                                                                                                                                                                           │ │
│ │ 2. Modify src/app/api/audio/[...slug]/route.ts:                                                                                                                                                                             │ │
│ │   - Check for existing chunks before generation                                                                                                                                                                             │ │
│ │   - Return partial content with appropriate headers                                                                                                                                                                         │ │
│ │   - Trigger background generation for missing chunks                                                                                                                                                                        │ │
│ │                                                                                                                                                                                                                             │ │
│ │ Frontend Changes:                                                                                                                                                                                                           │ │
│ │ 3. Modify src/components/AudioPlayer.tsx:                                                                                                                                                                                   │ │
│ │ - Handle partial audio responses                                                                                                                                                                                            │ │
│ │ - Implement background polling for missing chunks                                                                                                                                                                           │ │
│ │ - Show loading progress for chunks                                                                                                                                                                                          │ │
│ │ - Use MediaSource API or multiple audio elements for seamless playback                                                                                                                                                      │ │
│ │                                                                                                                                                                                                                             │ │
│ │ 6. Alternative Streaming Approach                                                                                                                                                                                           │ │
│ │                                                                                                                                                                                                                             │ │
│ │ As an enhancement, we could also implement:                                                                                                                                                                                 │ │
│ │ - Server-Sent Events (SSE) to notify when new chunks are ready                                                                                                                                                              │ │
│ │ - WebSocket connection for real-time chunk availability updates                                                                                                                                                             │ │
│ │ - Service Worker to handle chunk caching and assembly                                                                                                                                                                       │ │
│ │                                                                                                                                                                                                                             │ │
│ │ Benefits                                                                                                                                                                                                                    │ │
│ │                                                                                                                                                                                                                             │ │
│ │ 1. Resilience: Partial failures don't lose all progress                                                                                                                                                                     │ │
│ │ 2. Better UX: Users can start listening immediately with available chunks                                                                                                                                                   │ │
│ │ 3. Efficient: Only regenerate failed chunks, not entire audio                                                                                                                                                               │ │
│ │ 4. Progressive: Audio becomes available as it's generated                                                                                                                                                                   │ │
│ │                                                                                                                                                                                                                             │ │
│ │ Files to Modify                                                                                                                                                                                                             │ │
│ │                                                                                                                                                                                                                             │ │
│ │ 1. src/lib/workers-ai.ts - Add resilient chunking logic                                                                                                                                                                     │ │
│ │ 2. src/app/api/audio/[...slug]/route.ts - Handle partial responses                                                                                                                                                          │ │
│ │ 3. src/components/AudioPlayer.tsx - Progressive audio loading                                                                                                                                                               │ │
│ │ 4. Create src/lib/audio-chunk-manager.ts - Centralized chunk management                                                                                                                                                     │ │
│ │                                                                                                                                                                                                                             │ │
│ │ This approach ensures users can start listening even if some chunks fail, while the system automatically retries failed chunks in the background.
